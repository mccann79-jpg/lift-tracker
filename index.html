<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Tracker</title>
    
    
    <!-- iOS Home Screen Icons -->
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Workout">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            padding-bottom: 80px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .nav {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .nav-btn.active {
            background: white;
            color: #667eea;
        }

        .page {
            display: none;
            padding: 20px;
        }

        .page.active {
            display: block;
        }

        .form-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
            font-size: 14px;
        }

        select, input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: transform 0.2s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .exercise-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .exercise-name {
            font-weight: 600;
            font-size: 16px;
            color: #333;
        }

        .edit-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            margin-left: 5px;
        }

        .entry-list {
            margin-top: 10px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .entry-list.expanded {
            max-height: 500px;
        }

        .entry-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: #f8f9fa;
            margin-bottom: 5px;
            border-radius: 6px;
            font-size: 13px;
        }

        .entry-info {
            flex: 1;
        }

        .entry-actions {
            display: flex;
            gap: 5px;
        }

        .edit-entry-btn, .delete-entry-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
        }

        .edit-entry-btn {
            background: #667eea;
            color: white;
        }

        .delete-entry-btn {
            background: #dc3545;
            color: white;
        }

        .exercise-info {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }

        .chart-container {
            position: relative;
            height: 200px;
            margin-top: 10px;
        }

        .muscle-group {
            background: #667eea;
            color: white;
            padding: 12px 16px;
            font-weight: 600;
            margin: 20px 0 10px 0;
            border-radius: 8px;
            font-size: 14px;
        }

        .last-entry {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            color: #666;
            margin-top: 8px;
        }

        .data-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .no-data {
            text-align: center;
            color: #999;
            padding: 40px 20px;
            font-style: italic;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 500;
        }

        .filter-group {
            margin-bottom: 15px;
        }

        .equipment-tag {
            display: inline-block;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            color: #666;
        }

        input[type="file"] {
            padding: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            margin: 0;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .import-options {
            display: grid;
            gap: 10px;
            margin: 15px 0;
        }

        .radio-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .radio-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .radio-option input[type="radio"] {
            width: auto;
            margin-right: 10px;
        }

        .radio-option label {
            margin: 0;
            cursor: pointer;
            font-weight: normal;
        }

        .option-description {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .todays-workout-header {
            background: #667eea;
            color: white;
            padding: 12px 16px;
            font-weight: 600;
            margin: 20px 0 10px 0;
            border-radius: 8px;
            font-size: 14px;
        }

        .today-entry-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .today-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .today-exercise-name {
            font-weight: 600;
            font-size: 15px;
            color: #333;
        }

        .today-exercise-details {
            font-size: 14px;
            color: #666;
            margin-top: 4px;
        }

        .today-stats {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
            margin: 8px 0;
        }

        .exercise-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            margin-bottom: 8px;
            border-radius: 8px;
        }

        .exercise-list-info {
            flex: 1;
        }

        .exercise-list-name {
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }

        .exercise-list-details {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .delete-exercise-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ’ª Workout Tracker</h1>
        <p style="font-size: 12px; opacity: 0.9; margin-top: 5px;">âœ¨ Data syncs across all your devices</p>
        <div class="nav">
            <button class="nav-btn active" onclick="showPage('log')">Log</button>
            <button class="nav-btn" onclick="showPage('progress')">Progress</button>
            <button class="nav-btn" onclick="showPage('exercises')">Exercises</button>
            <button class="nav-btn" onclick="showPage('data')">Data</button>
        </div>
    </div>

    <!-- LOG PAGE -->
    <div id="log-page" class="page active">
        <div class="form-card">
            <h2 style="margin-bottom: 15px;">Log Workout</h2>
            <div id="success-msg" style="display: none;" class="success-message"></div>
            
            <form id="workout-form">
                <div class="form-group">
                    <label>Exercise</label>
                    <input type="text" id="exercise-search" placeholder="Type to search exercises..." style="margin-bottom: 10px;">
                    <select id="exercise-select" required size="5" style="height: auto;">
                        <option value="">Select an exercise...</option>
                    </select>
                </div>

                <div id="exercise-details" style="display: none;">
                    <div class="form-group">
                        <span class="equipment-tag" id="equipment-type"></span>
                    </div>

                    <div id="last-workout-info" style="display: none;" class="last-entry" style="margin-bottom: 15px;">
                    </div>

                    <div class="input-row">
                        <div class="form-group">
                            <label>Weight (lbs)</label>
                            <input type="number" id="weight-input" step="0.5" required>
                        </div>
                        <div class="form-group">
                            <label>Max Reps</label>
                            <input type="number" id="reps-input" min="1" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="date-input" required>
                    </div>

                    <button type="submit" class="btn">Add Entry</button>
                </div>
            </form>
        </div>

        <!-- Today's Workouts -->
        <div id="todays-workouts-container"></div>
    </div>

    <!-- PROGRESS PAGE -->
    <div id="progress-page" class="page">
        <div class="form-card">
            <div class="filter-group">
                <label>Filter by Muscle Group</label>
                <select id="muscle-filter">
                    <option value="">All Muscle Groups</option>
                </select>
            </div>
        </div>
        <div id="progress-container"></div>
    </div>

    <!-- EXERCISES PAGE -->
    <div id="exercises-page" class="page">
        <div class="form-card">
            <h2 style="margin-bottom: 15px;">Add Custom Exercise</h2>
            <form id="add-exercise-form">
                <div class="form-group">
                    <label>Muscle Group</label>
                    <select id="new-muscle-group" required>
                        <option value="">Select muscle group...</option>
                        <option value="QUADS">QUADS</option>
                        <option value="HAMSTRINGS">HAMSTRINGS</option>
                        <option value="GLUTES">GLUTES</option>
                        <option value="CHEST">CHEST</option>
                        <option value="BACK">BACK</option>
                        <option value="SHOULDERS">SHOULDERS</option>
                        <option value="BICEPS">BICEPS</option>
                        <option value="TRICEPS">TRICEPS</option>
                        <option value="CALVES">CALVES</option>
                        <option value="TRAPS">TRAPS</option>
                        <option value="ABS">ABS</option>
                        <option value="FOREARMS">FOREARMS</option>
                        <option value="NECK">NECK</option>
                        <option value="CARDIO">CARDIO</option>
                        <option value="OTHER">OTHER</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Exercise Name</label>
                    <input type="text" id="new-exercise-name" required placeholder="e.g., Bulgarian Split Squat">
                </div>
                <div class="form-group">
                    <label>Equipment Type</label>
                    <input type="text" id="new-equipment-type" required placeholder="e.g., Dumbbells, Machine, Barbell">
                </div>
                <button type="submit" class="btn">Add Exercise</button>
            </form>
        </div>

        <div class="form-card">
            <h2 style="margin-bottom: 15px;">All Exercises</h2>
            <input type="text" id="exercise-list-search" placeholder="Search exercises..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; margin-bottom: 15px;">
            <div id="exercises-list-container"></div>
        </div>
    </div>

    <!-- DATA PAGE -->
    <div id="data-page" class="page">
        <div class="form-card">
            <h2 style="margin-bottom: 15px;">Import/Export Data</h2>
            
            <button onclick="exportData()" class="btn">Export to CSV</button>
            
            <div style="margin: 20px 0; text-align: center; color: #999;">â€” or â€”</div>
            
            <button onclick="showImportModal()" class="btn btn-secondary">Import from CSV</button>

            <div style="margin-top: 30px;">
                <button onclick="clearAllData()" class="btn btn-secondary">Clear All Data</button>
            </div>
        </div>
    </div>

    <!-- Edit Entry Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Entry</h3>
                <button class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="edit-form">
                <input type="hidden" id="edit-entry-id">
                <div class="form-group">
                    <label>Exercise</label>
                    <input type="text" id="edit-exercise-name" disabled style="background: #f0f0f0;">
                </div>
                <div class="input-row">
                    <div class="form-group">
                        <label>Weight (lbs)</label>
                        <input type="number" id="edit-weight" step="0.5" required>
                    </div>
                    <div class="form-group">
                        <label>Max Reps</label>
                        <input type="number" id="edit-reps" min="1" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" id="edit-date" required>
                </div>
                <button type="submit" class="btn">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="import-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Import CSV Data</h3>
                <button class="close-btn" onclick="closeImportModal()">&times;</button>
            </div>
            
            <div class="import-options">
                <div class="radio-option">
                    <input type="radio" id="import-add" name="import-mode" value="add" checked>
                    <div>
                        <label for="import-add">Add to existing data</label>
                        <div class="option-description">Keep current entries and add new ones from CSV</div>
                    </div>
                </div>
                <div class="radio-option">
                    <input type="radio" id="import-replace" name="import-mode" value="replace">
                    <div>
                        <label for="import-replace">Replace all data</label>
                        <div class="option-description">Delete all current entries and import only CSV data</div>
                    </div>
                </div>
            </div>

            <input type="file" id="import-file" accept=".csv" style="margin: 15px 0;">
            
            <button onclick="executeImport()" class="btn">Import</button>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAq_2fKDm3LPSfFlwshMrRJgu0FMd2gmRg",
            authDomain: "lift-tracker-fd929.firebaseapp.com",
            databaseURL: "https://lift-tracker-fd929-default-rtdb.firebaseio.com",
            projectId: "lift-tracker-fd929",
            storageBucket: "lift-tracker-fd929.firebasestorage.app",
            messagingSenderId: "1096078363016",
            appId: "1:1096078363016:web:c1102613e2eb5497fd923d",
            measurementId: "G-KJZRPMQ4P8"
        };

        // Initialize Firebase
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }

        const defaultExercises = [
            {muscle: "QUADS", name: "Squat", equipment: "Barbell"},
            {muscle: "QUADS", name: "Squat (lighter)", equipment: "Barbell"},
            {muscle: "QUADS", name: "Leg Press", equipment: "Machine"},
            {muscle: "QUADS", name: "Leg Extension", equipment: "Machine"},
            {muscle: "QUADS", name: "Walking Lunge", equipment: "Dumbbells"},
            {muscle: "HAMSTRINGS", name: "Romanian Deadlift", equipment: "Barbell"},
            {muscle: "HAMSTRINGS", name: "Deadlift", equipment: "Barbell"},
            {muscle: "HAMSTRINGS", name: "Seated Leg Curl", equipment: "Machine"},
            {muscle: "GLUTES", name: "Nautilus Glute Drive", equipment: "Machine"},
            {muscle: "CHEST", name: "Bench Press", equipment: "Barbell"},
            {muscle: "CHEST", name: "Incline Bench Press", equipment: "Barbell"},
            {muscle: "CHEST", name: "Incline Bench Press", equipment: "Dumbell"},
            {muscle: "CHEST", name: "Weighted Dips", equipment: "Bodyweight + Weight"},
            {muscle: "CHEST", name: "Machine Pec Deck", equipment: "Machine"},
            {muscle: "BACK", name: "Chest Supp. T-Bar", equipment: "Machine"},
            {muscle: "BACK", name: "Pull Up", equipment: "Bodyweight + Weight"},
            {muscle: "BACK", name: "One-armed Row", equipment: "Dumbell"},
            {muscle: "SHOULDERS", name: "Overhead Press", equipment: "Barbell"},
            {muscle: "SHOULDERS", name: "Overhead Press", equipment: "Dumbbells"},
            {muscle: "SHOULDERS", name: "Lateral Raise", equipment: "Cable"},
            {muscle: "SHOULDERS", name: "Reverse Pec Deck", equipment: "Machine"},
            {muscle: "SHOULDERS", name: "Reverse Pec Deck", equipment: "Cable"},
            {muscle: "BICEPS", name: "Bayesian Cable Curl", equipment: "Cable"},
            {muscle: "BICEPS", name: "Preacher Curl", equipment: "EZ Bar/Dumbbells"},
            {muscle: "TRICEPS", name: "Ovrhd Cable Tri Ex.", equipment: "Cable"},
            {muscle: "CALVES", name: "Standing Calf Raise", equipment: "Machine"},
            {muscle: "TRAPS", name: "Dumbbell Shrugs", equipment: "Dumbbells"},
            {muscle: "ABS", name: "Cable Crunch", equipment: "Cable"},
            {muscle: "FOREARMS", name: "Dumbbell Wrist Curls/Extensions", equipment: "Dumbbells"},
            {muscle: "NECK", name: "Neck Curls/Extensions", equipment: "Plate/Harness"}
        ];

        let exercises = [...defaultExercises];
        let workoutData = [];

        // Initialize
        async function init() {
            populateExerciseDropdown();
            populateMuscleFilter();
            setTodayDate();
            await loadCustomExercises();
            await loadData();
            renderProgress();
            renderTodaysWorkouts();
            renderExercisesList();
        }

        async function loadCustomExercises() {
            if (!db) return;
            
            try {
                const snapshot = await db.collection('customExercises').get();
                const customExercises = [];
                snapshot.forEach(doc => {
                    customExercises.push({ id: doc.id, ...doc.data() });
                });
                
                exercises = [...defaultExercises, ...customExercises];
                populateExerciseDropdown();
                console.log(`Loaded ${customExercises.length} custom exercises`);
            } catch (error) {
                console.error('Error loading custom exercises:', error);
            }
        }

        async function saveCustomExercise(exercise) {
            if (!db) {
                alert('Database connection error.');
                return false;
            }
            
            try {
                await db.collection('customExercises').add(exercise);
                return true;
            } catch (error) {
                console.error('Error saving custom exercise:', error);
                alert('Error saving exercise. Please try again.');
                return false;
            }
        }

        async function deleteCustomExercise(id) {
            if (!db) {
                alert('Database connection error.');
                return false;
            }
            
            try {
                await db.collection('customExercises').doc(id).delete();
                return true;
            } catch (error) {
                console.error('Error deleting custom exercise:', error);
                alert('Error deleting exercise. Please try again.');
                return false;
            }
        }

        function renderTodaysWorkouts() {
            const container = document.getElementById('todays-workouts-container');
            const today = new Date().toISOString().split('T')[0];
            
            const todaysWorkouts = workoutData.filter(d => d.date === today);
            
            if (todaysWorkouts.length === 0) {
                container.innerHTML = '';
                return;
            }

            let html = '<div class="todays-workout-header">ðŸ“… Today\'s Workouts</div>';
            
            todaysWorkouts.forEach(entry => {
                html += `
                    <div class="today-entry-item">
                        <div class="today-entry-header">
                            <div>
                                <div class="today-exercise-name">${entry.exercise}</div>
                                <div class="today-exercise-details">
                                    <span class="equipment-tag">${entry.equipment}</span>
                                </div>
                            </div>
                            <div class="entry-actions">
                                <button class="edit-entry-btn" onclick='editEntry(${JSON.stringify(entry)})'>Edit</button>
                                <button class="delete-entry-btn" onclick='deleteEntry("${entry.id}")'>Delete</button>
                            </div>
                        </div>
                        <div class="today-stats">
                            ${entry.weight} lbs Ã— ${entry.reps} reps
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        async function loadData() {
            if (!db) {
                console.error('Firebase not initialized');
                return;
            }
            
            try {
                const snapshot = await db.collection('workouts').orderBy('timestamp', 'asc').get();
                workoutData = [];
                snapshot.forEach(doc => {
                    workoutData.push({ id: doc.id, ...doc.data() });
                });
                console.log(`Loaded ${workoutData.length} workout entries`);
            } catch (error) {
                console.error('Error loading data:', error);
                workoutData = [];
            }
        }

        async function saveData(entry) {
            if (!db) {
                console.error('Firebase not initialized');
                alert('Database connection error. Please check your Firebase configuration.');
                return false;
            }
            
            try {
                await db.collection('workouts').add(entry);
                return true;
            } catch (error) {
                console.error('Error saving data:', error);
                alert('Error saving data. Please try again.');
                return false;
            }
        }

        function populateExerciseDropdown() {
            const select = document.getElementById('exercise-select');
            select.innerHTML = '<option value="">Select an exercise...</option>';
            exercises.forEach((ex, idx) => {
                const option = document.createElement('option');
                option.value = idx;
                option.textContent = `${ex.name} (${ex.equipment})`;
                select.appendChild(option);
            });
        }

        // Exercise search functionality
        document.getElementById('exercise-search').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const select = document.getElementById('exercise-select');
            const options = select.querySelectorAll('option');
            
            options.forEach(option => {
                if (option.value === '') {
                    option.style.display = 'block';
                    return;
                }
                
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        });

        // Add custom exercise form
        document.getElementById('add-exercise-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const muscle = document.getElementById('new-muscle-group').value;
            const name = document.getElementById('new-exercise-name').value.trim();
            const equipment = document.getElementById('new-equipment-type').value.trim();
            
            // Check if exercise already exists
            const exists = exercises.some(ex => 
                ex.name.toLowerCase() === name.toLowerCase() && 
                ex.equipment.toLowerCase() === equipment.toLowerCase()
            );
            
            if (exists) {
                alert('This exercise already exists!');
                return;
            }
            
            const newExercise = {
                muscle: muscle,
                name: name,
                equipment: equipment
            };
            
            const saved = await saveCustomExercise(newExercise);
            if (saved) {
                await loadCustomExercises();
                renderExercisesList();
                
                // Reset form
                this.reset();
                alert('Exercise added successfully!');
            }
        });

        // Render exercises list
        function renderExercisesList() {
            const container = document.getElementById('exercises-list-container');
            const searchTerm = document.getElementById('exercise-list-search').value.toLowerCase();
            
            let html = '';
            let currentMuscle = '';
            
            const sortedExercises = [...exercises].sort((a, b) => {
                if (a.muscle !== b.muscle) return a.muscle.localeCompare(b.muscle);
                return a.name.localeCompare(b.name);
            });
            
            sortedExercises.forEach(ex => {
                // Filter by search
                const matchesSearch = !searchTerm || 
                    ex.name.toLowerCase().includes(searchTerm) ||
                    ex.equipment.toLowerCase().includes(searchTerm) ||
                    ex.muscle.toLowerCase().includes(searchTerm);
                
                if (!matchesSearch) return;
                
                // Add muscle group header
                if (currentMuscle !== ex.muscle) {
                    currentMuscle = ex.muscle;
                    html += `<div class="muscle-group" style="margin-top: 15px;">${ex.muscle}</div>`;
                }
                
                const isCustom = !defaultExercises.some(def => 
                    def.name === ex.name && def.equipment === ex.equipment
                );
                
                html += `
                    <div class="exercise-list-item">
                        <div class="exercise-list-info">
                            <div class="exercise-list-name">${ex.name}</div>
                            <div class="exercise-list-details">
                                <span class="equipment-tag">${ex.equipment}</span>
                                ${isCustom ? '<span class="equipment-tag" style="background: #667eea; color: white; margin-left: 5px;">Custom</span>' : ''}
                            </div>
                        </div>
                        ${isCustom && ex.id ? `<button class="delete-exercise-btn" onclick="removeExercise('${ex.id}')">Delete</button>` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html || '<div class="no-data">No exercises found</div>';
        }

        async function removeExercise(id) {
            if (!confirm('Delete this custom exercise? This will not delete your workout history.')) {
                return;
            }
            
            const deleted = await deleteCustomExercise(id);
            if (deleted) {
                await loadCustomExercises();
                renderExercisesList();
                alert('Exercise deleted successfully!');
            }
        }

        // Exercise list search
        document.getElementById('exercise-list-search').addEventListener('input', renderExercisesList);

        function populateMuscleFilter() {
            const select = document.getElementById('muscle-filter');
            const muscles = [...new Set(exercises.map(e => e.muscle))].sort();
            muscles.forEach(muscle => {
                const option = document.createElement('option');
                option.value = muscle;
                option.textContent = muscle;
                select.appendChild(option);
            });
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date-input').value = today;
        }

        document.getElementById('exercise-select').addEventListener('change', function() {
            const details = document.getElementById('exercise-details');
            const lastWorkoutDiv = document.getElementById('last-workout-info');
            
            if (this.value !== '') {
                const exercise = exercises[this.value];
                document.getElementById('equipment-type').textContent = exercise.equipment;
                
                // Find last workout for this exercise
                const exerciseHistory = workoutData.filter(d => 
                    d.exercise === exercise.name && d.equipment === exercise.equipment
                ).sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (exerciseHistory.length > 0) {
                    const last = exerciseHistory[0];
                    lastWorkoutDiv.innerHTML = `ðŸ“Š Last workout: <strong>${last.weight} lbs Ã— ${last.reps} reps</strong> on ${formatDate(last.date)}`;
                    lastWorkoutDiv.style.display = 'block';
                } else {
                    lastWorkoutDiv.innerHTML = 'ðŸ†• No previous workouts recorded';
                    lastWorkoutDiv.style.display = 'block';
                }
                
                details.style.display = 'block';
            } else {
                details.style.display = 'none';
                lastWorkoutDiv.style.display = 'none';
            }
        });

        document.getElementById('workout-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const exerciseIdx = document.getElementById('exercise-select').value;
            const weight = parseFloat(document.getElementById('weight-input').value);
            const reps = parseInt(document.getElementById('reps-input').value);
            const date = document.getElementById('date-input').value;

            const exercise = exercises[exerciseIdx];
            
            const entry = {
                muscle: exercise.muscle,
                exercise: exercise.name,
                equipment: exercise.equipment,
                weight: weight,
                reps: reps,
                date: date,
                timestamp: firebase.firestore.Timestamp.now()
            };

            const saved = await saveData(entry);
            if (!saved) return;

            // Add to local array
            workoutData.push(entry);

            // Show success message
            const msg = document.getElementById('success-msg');
            msg.textContent = `âœ“ Added ${exercise.name}: ${weight} lbs Ã— ${reps} reps`;
            msg.style.display = 'block';
            setTimeout(() => msg.style.display = 'none', 3000);

            // Reset form
            document.getElementById('weight-input').value = '';
            document.getElementById('reps-input').value = '';
            setTodayDate();

            // Update the last workout display
            document.getElementById('exercise-select').dispatchEvent(new Event('change'));

            renderProgress();
            renderTodaysWorkouts();
        });

        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(`${page}-page`).classList.add('active');
            event.target.classList.add('active');

            if (page === 'progress') {
                renderProgress();
            }
        }

        function renderProgress() {
            const container = document.getElementById('progress-container');
            const filter = document.getElementById('muscle-filter').value;
            
            container.innerHTML = '';

            if (workoutData.length === 0) {
                container.innerHTML = '<div class="no-data">No workout data yet. Start logging!</div>';
                return;
            }

            const filteredExercises = exercises.filter(ex => 
                !filter || ex.muscle === filter
            );

            let currentMuscle = '';
            
            filteredExercises.forEach(exercise => {
                const exerciseData = workoutData.filter(d => 
                    d.exercise === exercise.name && d.equipment === exercise.equipment
                );

                if (exerciseData.length === 0) return;

                if (currentMuscle !== exercise.muscle) {
                    currentMuscle = exercise.muscle;
                    const muscleHeader = document.createElement('div');
                    muscleHeader.className = 'muscle-group';
                    muscleHeader.textContent = exercise.muscle;
                    container.appendChild(muscleHeader);
                }

                const card = document.createElement('div');
                card.className = 'exercise-card';

                const sorted = exerciseData.sort((a, b) => new Date(a.date) - new Date(b.date));
                const latest = sorted[sorted.length - 1];
                const cardId = `card-${exercise.name}-${exercise.equipment}`.replace(/[^a-zA-Z0-9-]/g, '-');

                card.innerHTML = `
                    <div class="exercise-header">
                        <div class="exercise-name">${exercise.name}</div>
                        <button class="edit-btn" onclick="toggleEntries('${cardId}')">View All (${exerciseData.length})</button>
                    </div>
                    <div class="exercise-info">
                        <span class="equipment-tag">${exercise.equipment}</span>
                    </div>
                    <div class="last-entry">
                        Latest: ${latest.weight} lbs Ã— ${latest.reps} reps (${formatDate(latest.date)})
                    </div>
                    <div id="${cardId}" class="entry-list">
                        ${sorted.reverse().map(entry => `
                            <div class="entry-item">
                                <div class="entry-info">
                                    <strong>${entry.weight} lbs Ã— ${entry.reps} reps</strong> - ${formatDate(entry.date)}
                                </div>
                                <div class="entry-actions">
                                    <button class="edit-entry-btn" onclick='editEntry(${JSON.stringify(entry)})'>Edit</button>
                                    <button class="delete-entry-btn" onclick='deleteEntry("${entry.id}")'>Delete</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="chart-container">
                        <canvas id="chart-${exercise.name}-${exercise.equipment}"></canvas>
                    </div>
                `;

                container.appendChild(card);

                // Create chart
                const ctx = document.getElementById(`chart-${exercise.name}-${exercise.equipment}`);
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sorted.reverse().map(d => formatDate(d.date)),
                        datasets: [{
                            label: 'Weight (lbs)',
                            data: sorted.map(d => d.weight),
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        return value + ' lbs';
                                    }
                                }
                            }
                        }
                    }
                });
            });
        }

        function toggleEntries(cardId) {
            const entryList = document.getElementById(cardId);
            entryList.classList.toggle('expanded');
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return (date.getMonth() + 1) + '/' + date.getDate();
        }

        function editEntry(entry) {
            document.getElementById('edit-entry-id').value = entry.id;
            document.getElementById('edit-exercise-name').value = `${entry.exercise} (${entry.equipment})`;
            document.getElementById('edit-weight').value = entry.weight;
            document.getElementById('edit-reps').value = entry.reps;
            document.getElementById('edit-date').value = entry.date;
            document.getElementById('edit-modal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }

        document.getElementById('edit-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('edit-entry-id').value;
            const weight = parseFloat(document.getElementById('edit-weight').value);
            const reps = parseInt(document.getElementById('edit-reps').value);
            const date = document.getElementById('edit-date').value;

            if (!db) {
                alert('Database connection error.');
                return;
            }

            try {
                await db.collection('workouts').doc(id).update({
                    weight: weight,
                    reps: reps,
                    date: date
                });

                // Update local data
                const entry = workoutData.find(e => e.id === id);
                if (entry) {
                    entry.weight = weight;
                    entry.reps = reps;
                    entry.date = date;
                }

                closeEditModal();
                renderProgress();
                renderTodaysWorkouts();
                
                // Show success
                alert('Entry updated successfully!');
            } catch (error) {
                console.error('Error updating entry:', error);
                alert('Error updating entry. Please try again.');
            }
        });

        async function deleteEntry(id) {
            if (!confirm('Delete this entry?')) return;

            if (!db) {
                alert('Database connection error.');
                return;
            }

            try {
                await db.collection('workouts').doc(id).delete();
                
                // Remove from local data
                workoutData = workoutData.filter(e => e.id !== id);
                
                renderProgress();
                renderTodaysWorkouts();
                alert('Entry deleted successfully!');
            } catch (error) {
                console.error('Error deleting entry:', error);
                alert('Error deleting entry. Please try again.');
            }
        }

        document.getElementById('muscle-filter').addEventListener('change', renderProgress);

        function exportData() {
            if (workoutData.length === 0) {
                alert('No data to export!');
                return;
            }

            let csv = 'Muscle Group,Exercise,Equipment,Weight (lbs),Reps,Date\n';
            workoutData.forEach(entry => {
                csv += `${entry.muscle},${entry.exercise},${entry.equipment},${entry.weight},${entry.reps},${entry.date}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `workout-data-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function showImportModal() {
            document.getElementById('import-modal').classList.add('active');
        }

        function closeImportModal() {
            document.getElementById('import-modal').classList.remove('active');
            document.getElementById('import-file').value = '';
        }

        async function executeImport() {
            const file = document.getElementById('import-file').files[0];
            if (!file) {
                alert('Please select a CSV file to import.');
                return;
            }

            const mode = document.querySelector('input[name="import-mode"]:checked').value;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const text = e.target.result;
                const lines = text.split('\n').slice(1); // Skip header
                
                const imported = [];
                lines.forEach(line => {
                    if (line.trim()) {
                        const [muscle, exercise, equipment, weight, reps, date] = line.split(',');
                        imported.push({
                            muscle: muscle.trim(),
                            exercise: exercise.trim(),
                            equipment: equipment.trim(),
                            weight: parseFloat(weight),
                            reps: parseInt(reps),
                            date: date.trim(),
                            timestamp: firebase.firestore.Timestamp.now()
                        });
                    }
                });

                if (imported.length === 0) {
                    alert('No valid data found in CSV file.');
                    return;
                }

                const confirmMsg = mode === 'replace' 
                    ? `Replace ALL existing data with ${imported.length} new entries? This will DELETE all current workouts!`
                    : `Import ${imported.length} entries and add to existing data?`;

                if (!confirm(confirmMsg)) {
                    return;
                }
                
                if (!db) {
                    alert('Database connection error.');
                    return;
                }
                
                try {
                    const batch = db.batch();
                    
                    // If replace mode, delete all existing data first
                    if (mode === 'replace') {
                        const snapshot = await db.collection('workouts').get();
                        snapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                    }
                    
                    // Add imported data
                    imported.forEach(entry => {
                        const docRef = db.collection('workouts').doc();
                        batch.set(docRef, entry);
                    });
                    
                    await batch.commit();
                    
                    await loadData();
                    closeImportModal();
                    renderProgress();
                    
                    const successMsg = mode === 'replace'
                        ? 'All data replaced successfully!'
                        : 'Data imported successfully!';
                    alert(successMsg);
                } catch (error) {
                    console.error('Error importing:', error);
                    alert('Error importing data. Please try again.');
                }
            };
            reader.readAsText(file);
        }

        async function clearAllData() {
            if (!confirm('Are you sure you want to delete ALL workout data? This cannot be undone!')) {
                return;
            }
            
            if (!db) {
                alert('Database connection error.');
                return;
            }
            
            try {
                const batch = db.batch();
                const snapshot = await db.collection('workouts').get();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                
                workoutData = [];
                alert('All data cleared.');
                renderProgress();
            } catch (error) {
                console.error('Error clearing data:', error);
                alert('Error clearing data. Please try again.');
            }
        }

        // Initialize app
        init();
    </script>
</body>
</html>
